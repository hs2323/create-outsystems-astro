name: Test

on:
  pull_request:
  push:
    branches: [ main ]

env:
  NODE_VERSION: '24.12.0'

jobs:

  cli-bun:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Install Bun
        uses: oven-sh/setup-bun@v2.1.0

      - name: Install dependencies
        run: bun install

      - name: Run CLI
        run: bun run bin/cli.js --projectName test-islands --frameworks react

      - name: Run output
        working-directory: test-islands
        run: bun install && bun run output:bun

  cli-deno:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Install Deno
        uses: denoland/setup-deno@v2.0.3

      - name: Install dependencies
        run: deno install

      - name: Run CLI
        run: deno --allow-env --allow-read --allow-write --allow-run bin/cli.js --projectName test-islands --frameworks react

      - name: Run output
        working-directory: test-islands
        run: deno install && deno run postinstall && deno run output:deno

  cli-npm:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install

      - name: Run CLI
        run: npx create-outsystems-astro --projectName test-islands --frameworks react

      - name: Run output
        working-directory: test-islands
        run: npm ci && npm run output

  cli-pnpm:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4.2.0
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Run CLI
        run: pnpm exec bin/cli.js --projectName test-islands --frameworks react

      - name: Run output
        working-directory: test-islands
        run: pnpm install --frozen-lockfile && pnpm run output

  cli-yarn:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: yarn install

      - name: Link
        run: yarn link

      - name: Link package
        run: yarn link create-outsystems-astro

      - name: Run CLI
        run: |
          yarn add file:$GITHUB_WORKSPACE
          yarn create-outsystems-astro --projectName test-islands --frameworks react

      - name: Run output
        working-directory: test-islands
        run: yarn install --frozen-lockfile && yarn run output

  framework-all:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run CLI
        run: npx create-outsystems-astro --projectName test-islands --frameworks angular --frameworks react --frameworks vue

      - name: Run output
        working-directory: test-islands
        run: npm ci && npm run output

  framework-angular:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run CLI
        run: npx create-outsystems-astro --projectName test-islands --frameworks angular

      - name: Run output
        working-directory: test-islands
        run: npm ci && npm run output

  framework-react:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run CLI
        run: npx create-outsystems-astro --projectName test-islands --frameworks react

      - name: Run output
        working-directory: test-islands
        run: npm ci && npm run output

  framework-vue:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run CLI
        run: npx create-outsystems-astro --projectName test-islands --frameworks vue

      - name: Run output
        working-directory: test-islands
        run: npm ci && npm run output

  security-docs:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: docs
        run: npm ci

      - name: Run security check
        working-directory: docs
        run: npm audit

  security-template:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run security check
        working-directory: template
        run: npm audit

  test-bun:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Install Bun
        uses: oven-sh/setup-bun@v2.1.0

      - name: Install dependencies
        working-directory: template
        run: bun install --frozen-lockfile

      - name: Run CLI
        working-directory: template
        run: bun run test

  ## TODO: Fix Bun E2E tests
  # teste2e-bun:
  #   runs-on: ubuntu-latest

  #   steps:  
  #     - name: Checkout code
  #       uses: actions/checkout@v6.0.1

  #     - name: Install Bun
  #       uses: oven-sh/setup-bun@v2.1.0

  #     - name: Install dependencies
  #       working-directory: template
  #       run: bun install --frozen-lockfile

  #     - name: Install Playwright
  #       working-directory: template
  #       run: bun run test:e2e:install

  #     - name: Run tests
  #       working-directory: template
  #       run: bun run test:e2e

  test-deno:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Install Deno
        uses: denoland/setup-deno@v2.0.3

      - name: Install dependencies
        working-directory: template
        run: deno install --frozen && deno run postinstall

      - name: Run CLI
        working-directory: template
        run: deno run test

  teste2e-deno:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Install Deno
        uses: denoland/setup-deno@v2.0.3

      - name: Install dependencies
        working-directory: template
        run: deno install --frozen && deno run postinstall

      - name: Install Playwright
        working-directory: template
        run: npm run test:e2e:install

      - name: Run CLI
        working-directory: template
        run: deno run test:e2e:deno
  
  test-npm:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: template
        run: npm ci

      - name: Run tests
        working-directory: template
        run: npm run test

  teste2e-npm:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: template
        run: npm ci

      - name: Install Playwright
        working-directory: template
        run: npm run test:e2e:install

      - name: Run tests
        working-directory: template
        run: npm run test:e2e

  test-pnpm:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4.2.0
        with:
          version: 10

      - name: Install dependencies
        working-directory: template
        run: pnpm install --frozen-lockfile
      
      - name: Run tests
        working-directory: template
        run: pnpm run test

  teste2e-pnpm:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4.2.0
        with:
          version: 10

      - name: Install dependencies
        working-directory: template
        run: pnpm install --frozen-lockfile

      - name: Install Playwright
        working-directory: template
        run: pnpm run test:e2e:install
      
      - name: Run tests
        working-directory: template
        run: pnpm run test

  test-yarn:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: template
        run: yarn install --frozen-lockfile

      - name: Run output
        working-directory: template
        run: yarn test

  teste2e-yarn:
    runs-on: ubuntu-latest

    steps:  
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Use Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: template
        run: yarn install --frozen-lockfile

      - name: Install Playwright
        working-directory: template
        run: yarn run test:e2e:install

      - name: Run output
        working-directory: template
        run: yarn test:e2e
